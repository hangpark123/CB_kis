<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CB 뉴스/공시 대시보드</title>

  <!-- Chart.js (통계 차트는 CDN이 막혀도 다른 기능에 영향 없음) -->
  <script>
    (function(){
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/chart.js";
      s.async = true;
      s.onerror = () => console.warn('Chart.js blocked, stats disabled.');
      document.head.appendChild(s);
    })();
  </script>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .live-dot{ width:10px; height:10px; border-radius:9999px; display:inline-block; margin-right:6px }
    .live-on{  background:#22c55e; box-shadow:0 0 0 0 rgba(34,197,94,.7); animation:pulse 1.5s infinite }
    .live-off{ background:#ef4444 }
    @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(34,197,94,.7)} 70%{box-shadow:0 0 0 8px rgba(34,197,94,0)} 100%{box-shadow:0 0 0 0 rgba(34,197,94,0)} }

    /* 스크롤바 살짝 얇게 */
    #liveList::-webkit-scrollbar{ width: 8px; }
    #liveList::-webkit-scrollbar-thumb{ background:#1f2937; border-radius:8px; }
  </style>
</head>

<body class="bg-slate-950 text-slate-100">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <!-- Header -->
    <header class="flex items-end justify-between flex-wrap gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">CB 뉴스/공시 대시보드</h1>
        <p class="text-slate-400 text-sm">Live Ticker = 공시 · Top = 실시간 뉴스</p>
        <p class="text-xs text-slate-500" id="bootStatus">로딩 중...</p>
      </div>
      <div class="flex items-center gap-4">
        <label class="flex items-center gap-2">
          <input id="autoRefresh" type="checkbox" class="h-4 w-4" checked />
          <span class="text-sm text-slate-300">자동 새로고침</span>
        </label>
        <select id="refreshSec" class="bg-slate-800 text-slate-100 rounded px-2 py-1 text-sm">
          <option value="30" selected>30초</option>
          <option value="60">60초</option>
        </select>
        <button id="manualRefresh" class="bg-indigo-600 hover:bg-indigo-500 rounded px-3 py-1 text-sm">지금 새로고침</button>
      </div>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left: Top (뉴스 실시간) -->
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 lg:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <h2 class="font-semibold flex items-center gap-2">
              <span id="newsDot" class="live-dot live-off"></span>Top (뉴스 실시간)
            </h2>
            <input id="newsQ" placeholder="키워드(쉼표)" class="bg-slate-800 rounded px-2 py-1 text-sm w-64" value="전환사채,리픽싱" />
            <label class="text-sm flex items-center gap-2">
              <input id="newsLive" type="checkbox" class="h-4 w-4" checked />실시간
            </label>
            <button id="newsApply" class="bg-slate-800 hover:bg-slate-700 rounded px-2 py-1 text-sm">적용</button>
          </div>
          <div class="flex items-center gap-2">
            <select id="typeFilter" class="bg-slate-800 rounded px-2 py-1 text-sm">
              <option value="">전체 유형</option>
              <option>REFIX</option>
              <option>CONVERSION</option>
              <option>ISSUE</option>
              <option>REDEMPTION</option>
              <option>OTHER</option>
            </select>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="topTable">
            <thead class="text-slate-300">
              <tr class="border-b border-slate-800">
                <th class="text-left py-2 pr-3">시간</th>
                <th class="text-left py-2 pr-3">유형</th>
                <th class="text-left py-2 pr-3">회사/코드</th>
                <th class="text-left py-2">제목</th>
              </tr>
            </thead>
            <tbody id="topBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Right: Live Ticker (공시) + Chart -->
      <div class="space-y-6">
        <!-- Live Ticker -->
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
              <h2 class="font-semibold flex items-center gap-2">
                <span class="live-dot live-off" id="liveDot"></span>Live Ticker (공시)
              </h2>
              <select id="dartScope" class="bg-slate-800 rounded px-2 py-1 text-sm">
                <option value="cb" selected>CB 관련만</option>
                <option value="all">모든 공시</option>
              </select>
            </div>
            <div id="liveStat" class="text-xs text-slate-400">대기 중</div>
          </div>
          <!-- 고정 높이 + 세로 스크롤 -->
          <div id="liveList" class="space-y-2 h-[55vh] overflow-y-auto pr-1"></div>
        </div>

        <!-- 24h by-type -->
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
          <h2 class="font-semibold mb-3">24시간 유형 분포</h2>
          <canvas id="byTypeChart" height="240"></canvas>
          <p id="lastUpdated" class="text-xs text-slate-400 mt-2"></p>
        </div>
      </div>
    </section>
  </div>

  <script>
    /* ---------- 공용 포맷터 ---------- */
    // MM-DD
    function fmtMMDD(d){
      const pad = n => String(n).padStart(2,'0');
      return `${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    // MM-DD HH:MM
    function fmtMMDD_HHMM(d){
      const pad = n => String(n).padStart(2,'0');
      return `${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    const badge = (t) => {
      const cls = {
        "REFIX":"bg-amber-500/20 text-amber-300",
        "CONVERSION":"bg-emerald-500/20 text-emerald-300",
        "ISSUE":"bg-sky-500/20 text-sky-300",
        "REDEMPTION":"bg-rose-500/20 text-rose-300",
        "OTHER":"bg-slate-700 text-slate-300"
      }[t] || "bg-slate-700 text-slate-300";
      return `<span class="px-2 py-0.5 rounded text-xs ${cls}">${t||'OTHER'}</span>`;
    };
    const boot = document.getElementById('bootStatus');

    function showToast(msg){
      const t = document.createElement('div');
      t.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-800 text-slate-100 px-3 py-2 rounded shadow border border-slate-700 text-sm';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 2500);
    }

    /* ---------- DART field helpers ---------- */
    function dartReceiptNo(x){
      // rcp_no, rcpno, rcept_no, raw.rcpno 등 다양한 경우 대응
      const r = x.rcp_no || x.rcpno || x.rcept_no || (x.raw && (x.raw.rcpno || x.raw.rcept_no)) || null;
      return r ? String(r) : null;
    }
    function dartUrl(x){
      const r = dartReceiptNo(x);
      if (r) return '/go/dart/' + r;   // 백엔드 프록시 경유(403 회피)
      return x.url || null;
    }
    // 날짜/시간 파싱 + 표기
    // - 시간까지 있으면  "MM-DD HH:MM"
    // - 날짜만 있으면    "MM-DD"  (00:00 표시 안 함)
    function dartTimeInfo(x){
      const raw = x.raw || {};
      let source = x.time || x.published_at || x.inserted_at || raw.rcept_dt || raw.rcp_dt || '';
      if (!source) return { iso:'', display:'' };

      if (/^\d{8}$/.test(source)) {
        const y = source.slice(0,4), m = source.slice(4,6), d = source.slice(6,8);
        const iso = `${y}-${m}-${d}T00:00:00+09:00`;
        const dt  = new Date(iso);
        if (!Number.isNaN(dt.getTime())) {
          return { iso: dt.toISOString(), display: fmtMMDD(dt) };
        }
      }

      if (/^\d{4}-\d{2}-\d{2}$/.test(source)) {
        const iso = `${source}T00:00:00+09:00`;
        const dt  = new Date(iso);
        if (!Number.isNaN(dt.getTime())) {
          return { iso: dt.toISOString(), display: fmtMMDD(dt) };
        }
      }

      const m14 = source.match(/^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})$/);
      if (m14) {
        const [, y, m, d, hh, mm, ss] = m14;
        const iso = `${y}-${m}-${d}T${hh}:${mm}:${ss}+09:00`;
        const dt = new Date(iso);
        if (!Number.isNaN(dt.getTime())) {
          return { iso: dt.toISOString(), display: fmtMMDD_HHMM(dt) };
        }
      }

      const m12 = source.match(/^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})$/);
      if (m12) {
        const [, y, m, d, hh, mm] = m12;
        const iso = `${y}-${m}-${d}T${hh}:${mm}:00+09:00`;
        const dt = new Date(iso);
        if (!Number.isNaN(dt.getTime())) {
          return { iso: dt.toISOString(), display: fmtMMDD_HHMM(dt) };
        }
      }

      const parsed = new Date(source);
      if (!Number.isNaN(parsed.getTime())) {
        return { iso: parsed.toISOString(), display: fmtMMDD_HHMM(parsed) };
      }
      return { iso:'', display:'' };
    }

    function dartKey(x, idx=0){
      // 접수번호 → url → 헤드라인+시간 → 인덱스 폴백
      const r = dartReceiptNo(x);
      if (r) return `rcp:${r}`;
      const u = x.url || (x.raw && x.raw.url);
      const t = dartTimeInfo(x).iso;
      if (u && t) return `u:${u}|t:${t}`;
      if (u) return `u:${u}|i:${idx}`;
      const h = x.headline || (x.raw && (x.raw.report_nm || x.raw.rpt_nm));
      if (h && t) return `h:${h}|t:${t}`;
      return `idx:${idx}`;
    }

    /* ---------- Live Ticker (공시) ---------- */
    (function initDartTicker(){
      const liveList  = document.getElementById('liveList');
      const liveDot   = document.getElementById('liveDot');
      const liveStat  = document.getElementById('liveStat');
      const scopeSel  = document.getElementById('dartScope');
      let es = null;
      let seen = new Set();

      const render = (x) => {
        const info = dartTimeInfo(x);
        const t = info.display;
        const code = x.stock_code ? ` (${x.stock_code})` : '';
        const link = dartUrl(x) || '#';
        const corp = x.corp || (x.raw && (x.raw.corp_name || x.raw.corp || '')) || '-';
        const d = document.createElement('div');
        d.className = 'border border-slate-800 rounded p-2 whitespace-normal break-words';
        d.innerHTML =
          `<div class="text-xs text-slate-400">${t} · ${corp}${code}</div>
           <div class="text-sm">${x.headline || (x.raw && (x.raw.report_nm || x.raw.rpt_nm)) || ''} · <a class="underline text-indigo-300" target="_blank" rel="noopener noreferrer" href="${link}">공시</a></div>`;
        return d;
      };

      // 프리필: 2일 → 3일 → 7일로 늘려가며 최대 target(20)까지 채움
      async function prefill(target = 20) {
        liveList.innerHTML = '';
        seen = new Set();

        const scope = scopeSel.value;
        const minuteBuckets = [2880, 4320, 10080];   // 2d, 3d, 7d
        let added = 0;

        for (const minutes of minuteBuckets) {
          try {
            const res = await fetch(`/api/live/dart?scope=${scope}&minutes=${minutes}&limit=${target}`);
            if (!res.ok) throw new Error('prefill ' + res.status);
            const arr = await res.json();
            // 오래된 것부터 붙여서 최신이 위로
            arr.sort((a,b) => dartTimeInfo(a).iso.localeCompare(dartTimeInfo(b).iso));
            arr.forEach((x, i) => {
              if (added >= target) return;
              const key = dartKey(x, i);
              if (seen.has(key)) return;
              seen.add(key);
              liveList.appendChild(render(x));
              added++;
            });
          } catch(e) {
            console.warn('prefill dart failed', e);
          }
          if (added >= target) break;
        }

        if (added === 0) {
          const hint = (scope === 'cb') ? ' (스코프를 "모든 공시"로 바꿔보세요)' : '';
          const d = document.createElement('div');
          d.id = 'noPrefill';
          d.className = 'text-sm text-slate-400';
          d.textContent = `프리필 결과가 없습니다${hint}.`;
          liveList.appendChild(d);
        }
      }

      function cleanupES(){
        if (es) { try { es.close(); } catch(_){} es = null; }
      }

      function connect(){
        cleanupES();
        prefill(20);  // 먼저 20건 채움

        const scope = scopeSel.value;
        es = new EventSource(`/api/live/dart/stream?scope=${scope}&interval=8&minutes=120`);
        es.onopen  = () => { liveDot.className='live-dot live-on'; liveStat.textContent='연결됨'; boot.textContent='실시간 공시 연결 OK'; };
        es.onerror = () => { liveDot.className='live-dot live-off'; liveStat.textContent='오류/재시도 중'; };
        es.onmessage = (e) => {
          try{
            const x = JSON.parse(e.data);
            const key = dartKey(x);
            if (seen.has(key)) return;
            seen.add(key);
            const no = document.getElementById('noPrefill');
            if (no) no.remove();          // 안내문 제거
            liveList.prepend(render(x));  // 최신은 위로
            if (liveList.childElementCount > 200) {
              liveList.removeChild(liveList.lastElementChild);
            }
          }catch{}
        };
      }

      scopeSel.addEventListener('change', connect);
      connect(); // boot
    })();

    /* ---------- Top (뉴스 실시간) ---------- */
    (function initNewsTop(){
      const topBody   = document.getElementById('topBody');
      const newsQ     = document.getElementById('newsQ');
      const newsLive  = document.getElementById('newsLive');
      const newsApply = document.getElementById('newsApply');
      const typeFilter= document.getElementById('typeFilter');
      const newsDot   = document.getElementById('newsDot');

      const insertSorted = (row) => {
        const ts = Number(row.dataset.ts);
        if (!Number.isFinite(ts)) {
          topBody.appendChild(row);
          return;
        }
        let inserted = false;
        for (const child of topBody.children) {
          const childTs = Number(child.dataset.ts);
          if (!Number.isFinite(childTs) || childTs < ts) {
            topBody.insertBefore(row, child);
            inserted = true;
            break;
          }
        }
        if (!inserted) topBody.appendChild(row);
      };

      const renderRow = (x) => {
        const corp = `${x.corp || '-'}${x.stock_code ? ' (' + x.stock_code + ')' : ''}`;
        const url  = x.url
          ? `<a class="text-indigo-300 underline" href="${x.url}" target="_blank" rel="noopener noreferrer">기사</a>`
          : '';
        let ts = NaN;
        let t = '';
        if (x.time) {
          const dt = new Date(x.time);
          if (!Number.isNaN(dt.getTime())) {
            ts = dt.getTime();
            t = fmtMMDD_HHMM(dt);
          }
        }
        const tr = document.createElement('tr');
        tr.className = 'border-b border-slate-800/60 hover:bg-slate-800/30';
        if (!Number.isNaN(ts)) tr.dataset.ts = String(ts);
        tr.innerHTML =
          `<td class="py-2 pr-3 align-top whitespace-nowrap">${t}</td>
           <td class="py-2 pr-3 align-top">${badge(x.type)}</td>
           <td class="py-2 pr-3 align-top">${corp}</td>
           <td class="py-2 align-top">${x.headline || ''}${url ? ' · ' + url : ''}</td>`;
        return tr;
      };

      let es = null;
      let seen = new Set();
      let hbTimer = null;
      let lastMsg = 0;

      function buildNewsParams(){
        const hasQ = (newsQ.value||'').trim().length>0;
        const mode = hasQ ? 'all' : 'cb';   // 키워드가 있으면 all, 없으면 cb
        const q    = hasQ ? ('&q='+encodeURIComponent(newsQ.value)) : '';
        return { hasQ, mode, q };
      }

      async function loadOnce(){
        try{
          const { mode, q } = buildNewsParams();
          const res = await fetch('/api/live/news?minutes=180&mode='+mode+q);
          if(!res.ok) throw new Error('news load ' + res.status);
          const data = await res.json();
          topBody.innerHTML = '';
          seen = new Set();
          data.forEach(x => {
            const key = (x.url||'') + '|' + (x.time||'');
            if (!typeFilter.value || x.type===typeFilter.value) {
              insertSorted(renderRow(x));
            }
            seen.add(key);
          });
          if (data.length===0) showToast('���� ��� ���� (Ű����/��� Ȯ��)');
        }catch(e){ console.warn('news load error', e); showToast('���� �ε� ����'); }
      }

      function cleanupES(){
        if (es) { try { es.close(); } catch(_){} es = null; }
        if (hbTimer) { clearInterval(hbTimer); hbTimer = null; }
        newsDot.className = 'live-dot live-off';
      }

      function attachES(){
        cleanupES();
        topBody.innerHTML = '';
        seen = new Set();

        // 프리필 1회
        loadOnce();

        const { mode, q } = buildNewsParams();
        es = new EventSource('/api/live/stream?interval=8&minutes=180&mode='+mode+q);

        es.onopen = () => {
          newsDot.className = 'live-dot live-on';
          lastMsg = Date.now();
          // 10초마다 체크, 25초 이상 무소식이면 폴백 fetch
          hbTimer = setInterval(() => {
            if (Date.now() - lastMsg > 25000) {
              loadOnce();
              lastMsg = Date.now();
            }
          }, 10000);
        };

        es.onmessage = (e) => {
          try{
            const x = JSON.parse(e.data);
            if (typeFilter.value && x.type !== typeFilter.value) return;
            const key = (x.url||'') + '|' + (x.time||'');
            if (seen.has(key)) return;
            seen.add(key);
            const row = renderRow(x);
            insertSorted(row);
            if (topBody.childElementCount > 200) {
              topBody.removeChild(topBody.lastElementChild);
            }
            lastMsg = Date.now();
          }catch{}
        };

        es.onerror = () => {
          newsDot.className = 'live-dot live-off';
        };
      }

      newsApply.addEventListener('click', () => {
        if (newsLive.checked) attachES();
        else { cleanupES(); loadOnce(); }
      });

      // 탭 전환 시 연결 관리
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) cleanupES();
        else if (newsLive.checked) attachES();
      });

      // 시작
      if (newsLive.checked) attachES(); else loadOnce();
    })();

    /* ---------- Stats chart (optional) ---------- */
    (function initStats(){
      let chart;
      async function loadStats(){
        try{
          const res = await fetch('/api/stats/by_type?hours=24');
          const data = await res.json();
          if (typeof Chart === 'undefined') return; // CDN 차단 시 스킵
          const labels = Object.keys(data);
          const values = Object.values(data);
          const ctx = document.getElementById('byTypeChart');
          if (chart) chart.destroy();
          chart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: '건수', data: values }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
          });
          document.getElementById('lastUpdated').textContent = '업데이트: ' + new Date().toLocaleTimeString();
        }catch(e){ console.warn('stats error', e); }
      }

      let timer;
      function reschedule(){
        if (timer) clearInterval(timer);
        const enabled = document.getElementById('autoRefresh').checked;
        const sec = parseInt(document.getElementById('refreshSec').value, 10);
        if (enabled) timer = setInterval(loadStats, sec*1000);
      }

      document.getElementById('autoRefresh').addEventListener('change', reschedule);
      document.getElementById('refreshSec').addEventListener('change', reschedule);
      document.getElementById('manualRefresh').addEventListener('click', loadStats);

      loadStats();
      reschedule();
    })();
  </script>
</body>
</html>